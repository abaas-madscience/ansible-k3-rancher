---
- name: Install VictoriaMetrics Operator and monitoring stack
  hosts: control
  become: false
  tasks:

    - name: Create VM operator namespace
      command: kubectl create namespace vm-operator
      register: ns_create
      failed_when: false
      changed_when: "'created' in ns_create.stdout"

    - name: Add VictoriaMetrics Helm repo
      command: helm repo add vm https://victoriametrics.github.io/helm-charts/
      changed_when: true

    - name: Update Helm repos
      command: helm repo update
      changed_when: true

    - name: Install VictoriaMetrics Operator via Helm
      command: >
        helm upgrade --install vm-operator vm/victoria-metrics-operator
        --namespace vm-operator
        --create-namespace
      changed_when: true

    - name: Wait for VictoriaMetrics operator to become ready
      shell: |
        kubectl rollout status deployment/vm-operator-victoria-metrics-operator \
          -n vm-operator --timeout=60s
      changed_when: false

    - name: Apply minimal VMCluster
      copy:
        dest: /tmp/vmcluster.yaml
        content: |
          apiVersion: operator.victoriametrics.com/v1beta1
          kind: VMCluster
          metadata:
            name: vmcluster
            namespace: vm-operator
          spec:
            retentionPeriod: "1"
            vmstorage:
              replicaCount: 1
            vminsert:
              replicaCount: 1
            vmselect:
              replicaCount: 1

    - name: Apply VMCluster manifest
      command: kubectl apply -f /tmp/vmcluster.yaml

    - name: Apply VMAgent to scrape K8s nodes
      copy:
        dest: /tmp/vmagent.yaml
        content: |
          apiVersion: operator.victoriametrics.com/v1beta1
          kind: VMAgent
          metadata:
            name: vmagent
            namespace: vm-operator
          spec:
            replicaCount: 1
            selectAllByDefault: true
            externalLabels:
              cluster: lab
            scrapeInterval: "15s"

            remoteWrite:
              - url: http://vminsert-vmcluster.vm-operator.svc.cluster.local:8480/insert/0/prometheus



    - name: Apply VMAgent manifest
      command: kubectl apply -f /tmp/vmagent.yaml

    - name: Reserve MetalLB IP for metrics.lab.local
      copy:
        dest: /tmp/vm-metrics-lb.yaml
        content: |
          apiVersion: v1
          kind: Service
          metadata:
            name: vm-metrics
            namespace: vm-operator
          spec:
            type: LoadBalancer
            loadBalancerIP: 192.168.178.202
            ports:
              - name: http
                port: 80
                targetPort: 8481
            selector:
                app.kubernetes.io/name: vmselect

    - name: Deploy node-exporter as DaemonSet
      copy:
        dest: /tmp/node-exporter.yaml
        content: |
          apiVersion: apps/v1
          kind: DaemonSet
          metadata:
            name: node-exporter
            namespace: vm-operator
            labels:
              app: node-exporter
          spec:
            selector:
              matchLabels:
                app: node-exporter
            template:
              metadata:
                labels:
                  app: node-exporter
              spec:
                containers:
                  - name: node-exporter
                    image: quay.io/prometheus/node-exporter:v1.8.1
                    ports:
                      - containerPort: 9100
                        name: metrics
                    resources:
                      limits:
                        cpu: 100m
                        memory: 64Mi
                      requests:
                        cpu: 50m
                        memory: 32Mi
                    args:
                      - '--path.rootfs=/host'
                    volumeMounts:
                      - name: proc
                        mountPath: /host/proc
                        readOnly: true
                      - name: sys
                        mountPath: /host/sys
                        readOnly: true
                      - name: root
                        mountPath: /host
                        readOnly: true
                hostNetwork: true
                hostPID: true
                tolerations:
                  - operator: Exists
                volumes:
                  - name: proc
                    hostPath:
                      path: /proc
                  - name: sys
                    hostPath:
                      path: /sys
                  - name: root
                    hostPath:
                      path: /
    - name: Apply node-exporter DaemonSet
      command: kubectl apply -f /tmp/node-exporter.yaml

    - name: Create VMServiceScrape for node-exporter
      copy:
        dest: /tmp/vmscrape-nodeexporter.yaml
        content: |
          apiVersion: operator.victoriametrics.com/v1beta1
          kind: VMServiceScrape
          metadata:
            name: node-exporter
            namespace: vm-operator
          spec:
            selector:
              matchLabels:
                app: node-exporter
            namespaceSelector:
              matchNames:
                - vm-operator
            endpoints:
              - port: metrics
                interval: 15s
    - name: Apply VMServiceScrape for node-exporter
      command: kubectl apply -f /tmp/vmscrape-nodeexporter.yaml

    - name: Apply LoadBalancer service for metrics UI
      command: kubectl apply -f /tmp/vm-metrics-lb.yaml

    - name: Create Service for node-exporter
      copy:
        dest: /tmp/node-exporter-svc.yaml
        content: |
          apiVersion: v1
          kind: Service
          metadata:
            name: node-exporter
            namespace: vm-operator
            labels:
              app: node-exporter
          spec:
            selector:
              app: node-exporter
            ports:
              - name: metrics
                port: 9100
                targetPort: 9100
            clusterIP: None

    - name: Apply Service for node-exporter
      command: kubectl apply -f /tmp/node-exporter-svc.yaml


    - name: Show VictoriaMetrics message
      debug:
        msg: |
          VictoriaMetrics is exposed!

    - name: Show VictoriaMetrics external URL
      debug:
        msg: |
          âž¤ Visit: http://metrics.lab.local

    - name: Create MetalLB IPAddressPool for metrics.lab.local
      copy:
        dest: /tmp/metallb-metrics-pool.yaml
        content: |
          apiVersion: metallb.io/v1beta1
          kind: IPAddressPool
          metadata:
            name: metrics-pool
            namespace: metallb-system
          spec:
            addresses:
              - 192.168.178.202/32
          ---
          apiVersion: metallb.io/v1beta1
          kind: L2Advertisement
          metadata:
            name: metrics-advertise
            namespace: metallb-system

    - name: Apply metrics IP pool to MetalLB
      command: kubectl apply -f /tmp/metallb-metrics-pool.yaml
