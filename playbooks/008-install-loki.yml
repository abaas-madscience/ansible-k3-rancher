---
- name: Install Loki and Promtail for logs
  hosts: control
  become: false
  tasks:

    - name: Create monitoring namespace
      command: kubectl create namespace monitoring
      register: ns_create
      failed_when: false
      changed_when: "'created' in ns_create.stdout"

    - name: Add Grafana Helm repo
      command: helm repo add grafana https://grafana.github.io/helm-charts
      changed_when: true

    - name: Update Helm repos
      command: helm repo update
      changed_when: true

    - name: Copy Loki values file to control node
      copy:
        src: loki-values.yaml
        dest: /tmp/loki-values.yaml

    - name: Install Loki with custom values
      command: >
        helm upgrade --install loki grafana/loki
        --namespace monitoring
        --create-namespace
        -f /tmp/loki-values.yaml
      changed_when: true

    - name: Install Promtail via Helm
      command: >
        helm upgrade --install promtail grafana/promtail
        --namespace monitoring
        --set loki.serviceName=loki
      changed_when: true

    - name: Show Grafana Loki config tip
      debug:
        msg: |
          ðŸ” Loki is deployed.
          âž¤ In Grafana: Add Data Source > Loki
          âž¤ URL: http://loki.monitoring.svc.cluster.local:3100
